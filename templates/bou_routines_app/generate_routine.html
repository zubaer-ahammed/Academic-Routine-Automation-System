{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate New Routine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.13.18/jquery.timepicker.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-timepicker@1.13.18/jquery.timepicker.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-timerangepicker@0.1.1/jquery.timerangepicker.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/dmuy/MDTimePicker@v1.0.2-rc2/mdtimepicker.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Add Flatpickr CSS for multiple date selection -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="{% static 'global.css' %}">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
            margin: auto;
            padding: 2rem;
        }
        .container-bou {
            min-width: 80%;
        }
        .bou-header {
            padding-top: 0.5em;
            padding-bottom: 0.5em;
        }
        .container-box-bou {
            min-width: 80%;
            margin-top: 3rem;
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
            margin-bottom: 2rem;
        }
        .overlap-feedback {
            font-size: 0.85rem;
            padding: 0.5rem;
            margin-top: 0.25rem;
            border-radius: 4px;
            background-color: rgba(255, 0, 0, 0.1);
        }
        .course-row.has-overlap {
            padding: 0.5rem;
            background-color: rgba(255, 0, 0, 0.05);
            border-radius: 8px;
            border-left: 3px solid #dc3545;
        }
        #overlapWarning {
            animation: attention 1s ease-in-out infinite;
        }
        @keyframes attention {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        /* Fix for daterangepicker z-index */
        .daterangepicker {
            z-index: 999999 !important;
        }
        .form-control.mdtimepicker {
            background: #ccc;
        }
        /* Fix for flatpickr z-index */
        .flatpickr-calendar.open {
            z-index: 99999999;
        }
        .bou-logo {
            height: 70px;
            margin-right: 12px;
            vertical-align: middle;
        }
        table.generate-routine-table tbody tr td {
            font-size: 0.8em;
        }
        
        /* Inline editing styles */
        .course-cell {
            transition: all 0.2s ease;
        }
        
        .course-cell:hover {
            background-color: #0056b3 !important;
            transform: scale(1.02);
        }
        
        .course-cell .edit-controls {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 4px;
            padding: 8px;
            margin-top: 4px;
        }
        
        .course-cell .edit-controls .form-select {
            font-size: 0.75em;
            margin-bottom: 4px;
        }
        
        .course-cell .edit-controls .btn {
            font-size: 0.7em;
            padding: 2px 6px;
            margin: 0 2px;
        }
        
        .course-cell .edit-controls .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .course-cell .edit-controls .btn-secondary {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        
        /* Empty cell styles */
        .empty-cell {
            transition: all 0.2s ease;
        }
        
        .empty-cell:hover {
            background-color: #e9ecef !important;
            transform: scale(1.02);
        }
        
        .empty-cell .edit-controls {
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 4px;
            padding: 8px;
        }
        
        .empty-cell .edit-controls .form-select {
            font-size: 0.75em;
            margin-bottom: 4px;
        }
        
        .empty-cell .edit-controls .btn {
            font-size: 0.7em;
            padding: 2px 6px;
            margin: 0 2px;
        }

        #courseRepeater .course-row {
            display: flex;
            display: -webkit-flex;
            display: -moz-flex;
            flex-wrap: wrap;
        }

        .bou-footer-container {
            padding-bottom: 1em;
            padding-top: 1em;
        }

        @media screen and (max-width: 480px) {
            #courseRepeater .course-row .col {
                flex: initial;
                padding-bottom: 0.25em;
            }
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container container-bou bou-header">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="{% static 'bou_logo_icon.png' %}" alt="BOU Logo" class="bou-logo">
                <span>BOUSST  CSE Routine Generator</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
{#                    <li class="nav-item">#}
{#                        <a class="nav-link" href="/">Routine Entry</a>#}
{#                    </li>#}
                    <li class="nav-item">
                        <a class="nav-link active" href="/generate/">Generate Routine</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'update-semester-courses' %}">Semester Courses</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'download-routines' %}">Download Routines</a>
                    </li>
                    {% if user.is_authenticated %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'logout' %}?next={{ request.path }}">Logout</a>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'login' %}?next={{ request.path }}">Login</a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    <div class="container container-box-bou generate-routine-container">
        <h1>Generate Routine</h1>

        {% if messages %}
        <div class="messages mb-4">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Real-time overlap warning alert -->
        <div id="overlapWarning" class="alert alert-danger mb-4" style="display: none;">
            <strong>Warning: Time Overlaps Detected!</strong>
            <p>Please resolve the following overlaps before submitting:</p>
            <ul id="overlapList"></ul>
        </div>

        <form method="post">
            {% csrf_token %}
            <div class="mb-3">
                <label for="semester" class="form-label">Semester</label>
                <select name="semester" id="semester" class="form-control">
                    <option value="">Select Semester</option>
                    {% for semester in semesters %}
                    <option value="{{ semester.id }}" {% if selected_semester_id == semester.id|stringformat:"s" %}selected{% endif %}>{{ semester.name }}</option>
                    {% endfor %}
                </select>
                <div id="lunchBreakInfo" class="alert alert-info mt-2" style="display: none;"></div>
            </div>
            <div class="mb-3">
                <label for="date_range" class="form-label">Date Range</label>
                <input type="text" name="date_range" id="date_range" class="form-control" placeholder="Select date range">
            </div>

            <div class="mb-3">
                <label for="govt_holidays" class="form-label">Holidays <small class="text-muted">(No routines will be generated for these dates)</small></label>
                <input type="text" name="govt_holidays" id="govt_holidays" class="form-control" placeholder="Click to select government holidays">
                <div id="selectedHolidays" class="mt-2 d-flex flex-wrap gap-1"></div>
                <!-- Hidden input to store formatted holiday dates for backend processing -->
                <input type="hidden" name="govt_holiday_dates" id="govt_holiday_dates">
            </div>

            <div class="mb-3">
                <label for="makeup_dates" class="form-label">Makeup/Reserved Class Dates <small class="text-muted">(Only date and day will be shown, no pre-assigned classes)</small></label>
                <input type="text" name="makeup_dates" id="makeup_dates" class="form-control" placeholder="Click to select makeup/extra class dates">
                <div id="selectedMakeupDates" class="mt-2 d-flex flex-wrap gap-1"></div>
                <!-- Hidden input to store formatted makeup dates for backend processing -->
                <input type="hidden" name="makeup_date_list" id="makeup_date_list">
            </div>

            <div class="mb-3" id="lunchBreakSection">
                <label class="form-label">Lunch Break</label>
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">Start</span>
                            <input type="text" class="form-control mdtimepicker" id="lunchBreakStart" name="lunch_break_start" placeholder="Start time" autocomplete="off">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">End</span>
                            <input type="text" class="form-control mdtimepicker" id="lunchBreakEnd" name="lunch_break_end" placeholder="End time" autocomplete="off">
                        </div>
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">Lunch break will be enforced and times will update the semester.</small>
                <!-- Hidden inputs for always enforcing lunch break and updating semester -->
                <input type="hidden" name="enforce_lunch_break" value="1">
                <input type="hidden" name="update_semester_lunch_break" value="1">
            </div>

            <!-- Option for teacher's short name display in PDF -->
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" value="1" id="teacherShortNameNewline" name="teacher_short_name_newline" {% if teacher_short_name_newline %}checked{% endif %}>
                <label class="form-check-label" for="teacherShortNameNewline">
                    Show teacher's short name on a <strong>new line</strong> in the PDF (uncheck for same line as course code)
                </label>
            </div>

            <h5 class="mt-4 mb-3">Course Schedule</h5>

            <div id="courseRepeater">
                <div class="course-row row mb-3">
                    <div class="col">
                        <select name="course_code[]" class="form-control course-select">
                            <option value="">Select Course</option>
                            {% for course in courses %}
                            <option value="{{ course.id }}" data-teacher-id="{{ course.teacher.id }}">{{ course.code }} - {{ course.name }} ({{ course.teacher.name }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col">
                        <select name="day[]" class="form-control" required>
                            <option value="">Select Day</option>
                            <option value="Friday">Friday</option>
                            <option value="Saturday">Saturday</option>
                        </select>
                    </div>
                    <div class="col">
                        <div class="input-group">
                            <input type="text" name="start_time[]" class="form-control mdtimepicker time-input" placeholder="Start time" required autocomplete="off">
                            <span class="input-group-text">to</span>
                            <input type="text" name="end_time[]" class="form-control mdtimepicker time-input" placeholder="End time" required autocomplete="off">
                        </div>
                        <div class="overlap-feedback text-danger mt-1" style="display: none;"></div>
                        <div class="checking-feedback text-muted mt-1" style="display: none;">
                            <small><i>Checking for time overlaps...</i></small>
                        </div>
                    </div>
                    <div class="col-auto">
                        <button type="button" class="btn btn-danger remove-course">Remove</button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-secondary mb-3" id="addCourse">+ Add Another Course</button>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success btn-lg">Generate Routine</button>
                <small class="text-muted text-center mt-2">All time overlaps must be resolved before generating the routine. Also, this will override the existing routine for the selected semester.</small>
            </div>
        </form>

        {% if generated_routines %}
        <div class="mt-5">
            <h2 class="text-center mb-4">
                {% if request.method == "GET" and selected_semester_id %}
                    Existing Generated Routine
                {% else %}
                    Generated Routine
                {% endif %}
            </h2>
            
            {% if request.method == "GET" and selected_semester_id %}
            <div class="alert alert-info mb-4">
                <h5><i class="bi bi-info-circle-fill"></i> Existing Routine Loaded</h5>
                <p class="mb-0">Showing previously generated routine for the selected semester. You can modify the form below and click "Generate Routine" to create a new schedule.</p>
            </div>
            {% endif %}

            <!-- Visual Calendar View (MERGED TIME SLOTS) -->
            <div class="card mb-4">
                <div class="card-header bg-dark text-white text-center">
                    <h4 class="mb-0">Routine Calendar</h4>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-bordered border-dark mb-0 generate-routine-table">
                            <thead>
                                <tr class="bg-dark text-white text-center">
                                    <th class="date_title" width="9%" style="vertical-align: middle;">Date</th>
                                    <th class="day_title" width="7%" style="vertical-align: middle;">Day</th>
                                    <th class="class_hour_title" width="84%" style="vertical-align: middle;" colspan="{{ time_slot_labels|length }}">Class Hour</th>
                                </tr>
                                <tr class="bg-secondary text-white text-center">
                                    <th></th>
                                    <th></th>
                                    {% for slot in time_slot_labels %}
                                        <th>{{ slot }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in routine_table_rows %}
                                <tr>
                                    <td class="text-center fw-bold align-middle" data-date="{{ row.date|date:'Y-m-d' }}">{{ row.date|date:"d/m/Y" }}</td>
                                    <td class="text-center fw-bold align-middle">{{ row.day }}</td>
                                    {% for cell in row.cells %}
                                        {% if cell.content %}
                                            {% if cell.is_lunch_break %}
                                                <td colspan="{{ cell.colspan }}" class="bg-warning bg-opacity-25 text-center align-middle fw-bold">{{ cell.content }}</td>
                                            {% else %}
                                                <td colspan="{{ cell.colspan }}" class="bg-primary text-white text-center align-middle course-cell" 
                                                    data-routine-id="{{ cell.content.routine_id }}" 
                                                    data-course-id="{{ cell.content.course_id }}"
                                                    style="cursor: pointer; position: relative;">
                                                    <span style="position: absolute; top: 2px; right: 4px; z-index: 2; cursor: pointer; opacity: 0.8; color: #1E1E1E;" title="Edit course">
                                                      <!-- Pen SVG icon -->
                                                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.3 3.7l4 4L7 17H3v-4l9.3-9.3z"/><path d="M15.7 6.3l-2-2"/></svg>
                                                    </span>
                                                    <span style="position: absolute; top: 2px; left: 4px; z-index: 2; cursor: pointer; opacity: 0.8; color: #1E1E1E;" class="remove-course-btn" title="Remove course">
                                                      <!-- Trash SVG icon -->
                                                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                                    </span>
                                                    <div class="fw-bold course-code">{{ cell.content.course_code }}</div>
                                                    <div><small class="teacher-name">({{ cell.content.teacher }})</small></div>
                                                    <div class="edit-controls" style="display: none;">
                                                        <select class="form-select form-select-sm course-select-edit">
                                                            <option value="">Select Course</option>
                                                            <!-- Options will be populated dynamically via JS -->
                                                        </select>
                                                        <div class="mt-1">
                                                            <button type="button" class="btn btn-success btn-sm save-course">Save</button>
                                                            <button type="button" class="btn btn-secondary btn-sm cancel-edit">Cancel</button>
                                                        </div>
                                                    </div>
                                                </td>
                                            {% endif %}
                                        {% else %}
                                            <!-- DEBUG: cell data = {{ cell|safe }} -->
                                            <!-- DEBUG: cell.start_time = {{ cell.start_time }} -->
                                            <!-- DEBUG: cell.end_time = {{ cell.end_time }} -->
                                            <td colspan="{{ cell.colspan }}" class="empty-cell"
                                                data-date="{{ row.date|date:'Y-m-d' }}"
                                                data-day="{{ row.day }}"
                                                data-time-slot="{{ forloop.counter0 }}"
                                                data-start-time="{{ cell.start_time }}"
                                                data-end-time="{{ cell.end_time }}"
                                                style="cursor: pointer; background-color: #f8f9fa; position: relative;">
                                                <span style="position: absolute; top: 2px; right: 4px; z-index: 2; cursor: pointer; opacity: 0.8; color: #1E1E1E;" title="Add course">
                                                  <!-- Pen SVG icon -->
                                                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.3 3.7l4 4L7 17H3v-4l9.3-9.3z"/><path d="M15.7 6.3l-2-2"/></svg>
                                                </span>
                                                <div class="empty-cell-content" style="display: block;">
                                                    <small class="text-muted">Click to add course</small>
                                                </div>
                                                <div class="edit-controls" style="display: none;">
                                                    <select class="form-select form-select-sm course-select-edit">
                                                        <option value="">Select Course</option>
                                                        <!-- Options will be populated dynamically via JS -->
                                                    </select>
                                                    <div class="mt-1">
                                                        <button type="button" class="btn btn-success btn-sm save-course">Save</button>
                                                        <button type="button" class="btn btn-secondary btn-sm cancel-edit">Cancel</button>
                                                    </div>
                                                </div>
                                            </td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        
            <div class="d-grid gap-2 mt-3">
                <div class="row">
                    <div class="col-md-6">
                        <form id="pdfExportForm" method="get" action="{% url 'export-to-pdf' selected_semester_id %}" style="display:inline;">
                            <input type="hidden" name="teacher_short_name_newline" id="pdfTeacherShortNameNewline" value="1">
                            <button type="submit" class="btn btn-danger w-100">
                                <i class="bi bi-file-earmark-pdf"></i> Download Routine as PDF
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <a href="{% url 'export-to-excel' selected_semester_id %}" class="btn btn-success w-100">
                            <i class="bi bi-file-earmark-excel"></i> Download Routine as Excel
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if error %}
        <div class="alert alert-danger mt-4">
            <h4 class="alert-heading">Error!</h4>
            <p>{{ error }}</p>
        </div>
        {% endif %}

        {% if overlap_conflicts %}
        <div class="alert alert-danger mt-4">
            <h4 class="alert-heading">Time Conflict Detected!</h4>
            <p>The following routines have overlapping time slots for the same teacher:</p>
            <ul class="list-group mb-3">
                {% for conflict in overlap_conflicts %}
                <li class="list-group-item list-group-item-danger">
                    <strong>{{ conflict.day }}:</strong> {{ conflict.course }} ({{ conflict.teacher }}) <span class="badge bg-warning text-dark">{{ conflict.start }} - {{ conflict.end }}</span>
                </li>
                {% endfor %}
            </ul>
            <hr>
            <p class="mb-0">Please adjust the time slots to prevent overlaps before generating the routine.</p>
        </div>
        {% endif %}
    </div>

    <!-- Copyright Footer -->
    <footer class="bg-dark text-white text-center py-3 mt-5">
        <div class="container bou-footer-container container-bou">
            <p class="mb-0">
                © <span id="currentYear"></span> BOUSST  CSE Routine Generator. Developed by
                <a href="https://github.com/zubaer-ahammed/" target="_blank" class="text-info">Md. Zubaer Ahammed</a> and
                <a href="https://github.com/Mojahidul21" target="_blank" class="text-info">Mojahidul Alam</a>
            </p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dmuy/MDTimePicker@v1.0.2-rc2/mdtimepicker.min.js"></script>
    <!-- Add Flatpickr JS for multiple date selection -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        $(function() {
            // Set the current year in the footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Helper function to parse time string (HH:MM) into a Date object
            function parseTimeString(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const date = new Date();
                date.setHours(hours, minutes, 0, 0);
                return date;
            }

            // Helper function to check if two time ranges overlap
            // Two time ranges overlap if:
            // 1. The start time of range1 is before the end time of range2 AND
            // 2. The start time of range2 is before the end time of range1
            function doTimesOverlap(start1, end1, start2, end2) {
                return start1 < end2 && start2 < end1;
            }

            // --- NEW: Check for overlaps between any two courses on the same day ---
            function checkAllCourseOverlaps() {
                let hasOverlap = false;
                let allOverlaps = [];
                let duplicateCourse = false;
                let duplicateMessages = [];

                // Gather all course rows' info
                let rows = [];
                $('.course-row').each(function(idx) {
                    const courseCode = $(this).find('select[name="course_code[]"]').val();
                    const day = $(this).find('select[name="day[]"]').val();
                    const startTime = $(this).find('input[name="start_time[]"]').val();
                    const endTime = $(this).find('input[name="end_time[]"]').val();
                    rows.push({ idx, courseCode, day, startTime, endTime, row: $(this) });
                });

                // Clear previous overlap/duplicate state
                $('.course-row').each(function() {
                    // Only clear if not a lunch break warning
                    const feedback = $(this).find('.overlap-feedback');
                    if (!feedback.text().includes('lunch break')) {
                        $(this).removeClass('has-overlap has-duplicate');
                        feedback.hide().empty();
                    }
                });

                // Compare every pair of rows
                for (let i = 0; i < rows.length; i++) {
                    for (let j = i + 1; j < rows.length; j++) {
                        // --- Overlap check ---
                        if (
                            rows[i].day && rows[j].day &&
                            rows[i].day === rows[j].day &&
                            rows[i].startTime && rows[i].endTime &&
                            rows[j].startTime && rows[j].endTime
                        ) {
                            // Parse times
                            const s1 = parseTimeString(rows[i].startTime);
                            const e1 = parseTimeString(rows[i].endTime);
                            const s2 = parseTimeString(rows[j].startTime);
                            const e2 = parseTimeString(rows[j].endTime);

                            if (doTimesOverlap(s1, e1, s2, e2)) {
                                // Mark both rows as having overlap
                                rows[i].row.addClass('has-overlap');
                                rows[j].row.addClass('has-overlap');
                                rows[i].row.find('.overlap-feedback').show().text('Overlaps with another course on this day');
                                rows[j].row.find('.overlap-feedback').show().text('Overlaps with another course on this day');
                                hasOverlap = true;
                                allOverlaps.push(
                                    `Course ${i+1} and Course ${j+1} overlap on ${rows[i].day} (${rows[i].startTime}-${rows[i].endTime} & ${rows[j].startTime}-${rows[j].endTime})`
                                );
                            }
                        }
                        // --- Duplicate course check (same course, same day) ---
                        if (
                            rows[i].courseCode && rows[j].courseCode &&
                            rows[i].day && rows[j].day &&
                            rows[i].day === rows[j].day &&
                            rows[i].courseCode === rows[j].courseCode
                        ) {
                            rows[i].row.addClass('has-duplicate');
                            rows[j].row.addClass('has-duplicate');
                            rows[i].row.find('.overlap-feedback').show().text('This course is already selected for this day');
                            rows[j].row.find('.overlap-feedback').show().text('This course is already selected for this day');
                            duplicateCourse = true;
                            duplicateMessages.push(
                                `Course ${i+1} and Course ${j+1} are both set to the same course on ${rows[i].day}`
                            );
                        }
                    }
                }

                // Check for lunch break warning in any row
                let lunchBreakConflict = false;
                $('.course-row .overlap-feedback').each(function() {
                    if ($(this).text().includes('lunch break')) {
                        lunchBreakConflict = true;
                    }
                });

                // Show/hide global warning
                if (hasOverlap || duplicateCourse || lunchBreakConflict) {
                    const overlapList = $('#overlapList');
                    overlapList.empty();
                    allOverlaps.forEach(overlap => {
                        overlapList.append(`<li>${overlap}</li>`);
                    });
                    duplicateMessages.forEach(msg => {
                        overlapList.append(`<li>${msg}</li>`);
                    });
                    $('#overlapWarning').show();
                    // Only enable if no lunch break conflict
                    if (!lunchBreakConflict) {
                        $('button[type="submit"]').prop('disabled', false);
                    } else {
                        $('button[type="submit"]').prop('disabled', true);
                    }
                } else {
                    $('#overlapWarning').hide();
                    $('button[type="submit"]').prop('disabled', false);
                }
            }

            $('#date_range').daterangepicker({
                opens: 'right',
                autoUpdateInput: false // Prevent auto-filling with current date
            });

            // Initialize the date picker when a value is available
            $('#date_range').on('apply.daterangepicker', function(ev, picker) {
                $(this).val(picker.startDate.format('MM/DD/YYYY') + ' - ' + picker.endDate.format('MM/DD/YYYY'));
            });

            // Clear the date range value when canceled
            $('#date_range').on('cancel.daterangepicker', function(ev, picker) {
                $(this).val('');
            });

            // Initialize Flatpickr for government holidays date selection
            $('#govt_holidays').flatpickr({
                mode: 'multiple',
                dateFormat: 'Y-m-d',
                onChange: function(selectedDates, dateStr, instance) {
                    // Format dates for display and submission
                    let formattedDates = selectedDates.map(date => {
                        return instance.formatDate(date, 'Y-m-d');
                    });

                    // Store the selected dates in the hidden input for form submission
                    $('#govt_holiday_dates').val(formattedDates.join(','));

                    // Display selected dates as badges for user feedback
                    $('#selectedHolidays').empty();
                    formattedDates.forEach(date => {
                        const formattedDate = new Date(date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        const badge = $(`<span class="badge bg-info me-1 mb-1" data-date="${date}">${formattedDate} <i class="bi bi-x-circle" style="cursor: pointer;"></i></span>`);
                        $('#selectedHolidays').append(badge);
                    });
                }
            });

            // Allow removing individual holidays by clicking on the x icon
            $(document).on('click', '#selectedHolidays .badge .bi-x-circle', function(e) {
                e.stopPropagation(); // Prevent event bubbling
                const badge = $(this).parent();
                const dateStr = badge.data('date');
                const picker = $('#govt_holidays')[0]._flatpickr;

                if (picker) {
                    // First, remove the visual badge
                    badge.remove();

                    // Create a JavaScript Date object from the date string
                    const dateToRemove = new Date(dateStr);

                    // Get all current selected dates from the picker
                    const currentDates = picker.selectedDates;

                    // Find and remove the matching date
                    const filteredDates = currentDates.filter(date => {
                        // Compare dates by converting to the same format
                        return picker.formatDate(date, 'Y-m-d') !== dateStr;
                    });

                    // Clear the picker completely
                    picker.clear();

                    // Set the remaining dates back
                    if (filteredDates.length > 0) {
                        picker.setDate(filteredDates, false); // false = don't trigger onChange
                    }

                    // Update the hidden input manually since we disabled the onChange trigger
                    const formattedDates = filteredDates.map(date => {
                        return picker.formatDate(date, 'Y-m-d');
                    });
                    $('#govt_holiday_dates').val(formattedDates.join(','));

                    // Update the display of selected dates (in case anything was missed)
                    updateHolidayBadges(filteredDates, picker);
                }
            });

            // Helper function to update the holiday badges display
            function updateHolidayBadges(dates, picker) {
                $('#selectedHolidays').empty();
                dates.forEach(date => {
                    const formattedDate = new Date(date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    const dateStr = picker.formatDate(date, 'Y-m-d');
                    const badge = $(`<span class="badge bg-info me-1 mb-1" data-date="${dateStr}">${formattedDate} <i class="bi bi-x-circle" style="cursor: pointer;"></i></span>`);
                    $('#selectedHolidays').append(badge);
                });
            }

            // Initialize Flatpickr for makeup/extra class dates selection
            $('#makeup_dates').flatpickr({
                mode: 'multiple',
                dateFormat: 'Y-m-d',
                onChange: function(selectedDates, dateStr, instance) {
                    // Format dates for display and submission
                    let formattedDates = selectedDates.map(date => {
                        return instance.formatDate(date, 'Y-m-d');
                    });

                    // Store the selected dates in the hidden input for form submission
                    $('#makeup_date_list').val(formattedDates.join(','));

                    // Display selected dates as badges for user feedback
                    $('#selectedMakeupDates').empty();
                    formattedDates.forEach(date => {
                        const formattedDate = new Date(date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        const badge = $(`<span class="badge bg-success me-1 mb-1" data-date="${date}">${formattedDate} <i class="bi bi-x-circle" style="cursor: pointer;"></i></span>`);
                        $('#selectedMakeupDates').append(badge);
                    });
                }
            });

            // Allow removing individual makeup dates by clicking on the x icon
            $(document).on('click', '#selectedMakeupDates .badge .bi-x-circle', function(e) {
                e.stopPropagation(); // Prevent event bubbling
                const badge = $(this).parent();
                const dateStr = badge.data('date');
                const picker = $('#makeup_dates')[0]._flatpickr;

                if (picker) {
                    // First, remove the visual badge
                    badge.remove();

                    // Create a JavaScript Date object from the date string
                    const dateToRemove = new Date(dateStr);

                    // Get all current selected dates from the picker
                    const currentDates = picker.selectedDates;

                    // Find and remove the matching date
                    const filteredDates = currentDates.filter(date => {
                        // Compare dates by converting to the same format
                        return picker.formatDate(date, 'Y-m-d') !== dateStr;
                    });

                    // Clear the picker completely
                    picker.clear();

                    // Set the remaining dates back
                    if (filteredDates.length > 0) {
                        picker.setDate(filteredDates, false); // false = don't trigger onChange
                    }

                    // Update the hidden input manually since we disabled the onChange trigger
                    const formattedDates = filteredDates.map(date => {
                        return picker.formatDate(date, 'Y-m-d');
                    });
                    $('#makeup_date_list').val(formattedDates.join(','));

                    // Update the display of selected dates (in case anything was missed)
                    updateMakeupDateBadges(filteredDates, picker);
                }
            });

            // Helper function to update the makeup date badges display
            function updateMakeupDateBadges(dates, picker) {
                $('#selectedMakeupDates').empty();
                dates.forEach(date => {
                    const formattedDate = new Date(date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });
                    const dateStr = picker.formatDate(date, 'Y-m-d');
                    const badge = $(`<span class="badge bg-success me-1 mb-1" data-date="${dateStr}">${formattedDate} <i class="bi bi-x-circle" style="cursor: pointer;"></i></span>`);
                    $('#selectedMakeupDates').append(badge);
                });
            }

            // Initialize mdtimepicker for each time input
            function initMDTimePickers() {
                $('.mdtimepicker').each(function() {
                    // First destroy any existing timepicker instance to avoid conflicts
                    if ($(this).data('mdtimepicker')) {
                        $(this).mdtimepicker('destroy');
                    }

                    // Then initialize a new instance
                    $(this).mdtimepicker({
                        format: 'hh:mm',
                        theme: 'blue',
                        hourPadding: true
                    }).data('mdtimepicker-initialized', true);
                });
            }
            initMDTimePickers();

            // Form submission validation
            $('form').on('submit', function(e) {
                // Check all rows one more time for overlaps
                let hasOverlap = false;
                let hasEmptyFields = false;

                // Check for empty required fields
                if (!$('#semester').val()) {
                    alert('Please select a semester');
                    e.preventDefault();
                    return false;
                }

                if (!$('#date_range').val()) {
                    alert('Please select a date range');
                    e.preventDefault();
                    return false;
                }

                // Check all course rows
                $('.course-row').each(function() {
                    // Check for overlaps
                    if ($(this).find('.overlap-feedback').is(':visible')) {
                        hasOverlap = true;
                    }

                    // Check for empty fields
                    const courseCode = $(this).find('select[name="course_code[]"]').val();
                    const day = $(this).find('select[name="day[]"]').val();
                    const startTime = $(this).find('input[name="start_time[]"]').val();
                    const endTime = $(this).find('input[name="end_time[]"]').val();

                    if (!courseCode || !day || !startTime || !endTime) {
                        hasEmptyFields = true;
                    }
                });

                if (hasEmptyFields) {
                    alert('Please fill in all course details (course, day, start time, end time)');
                    e.preventDefault();
                    return false;
                }

                if (hasOverlap) {
                    e.preventDefault();
                    // Scroll to the warning
                    $('#overlapWarning')[0].scrollIntoView({ behavior: 'smooth' });
                    // Flash the warning for attention
                    $('#overlapWarning').fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);
                    return false;
                }

                return true;
            });

            // Load semester courses function
            function loadSemesterCourses(semesterId) {
                if (semesterId) {
                    // Clear existing course options
                    $('.course-select').each(function() {
                        const select = $(this);
                        // Save the first option (Select Course)
                        const firstOption = select.find('option:first').clone();
                        select.empty().append(firstOption);
                    });

                    // Fetch courses for the selected semester
                    $.ajax({
                        url: "{% url 'get-semester-courses' %}",
                        data: {
                            'semester_id': semesterId
                        },
                        dataType: 'json',
                        success: function(data) {
                            if (data.courses && data.courses.length > 0) {
                                // Create options for each course
                                const options = data.courses.map(course =>
                                    `<option value="${course.id}" data-teacher-id="${course.teacher_id}">${course.code} - ${course.name} (${course.teacher_name})</option>`
                                );

                                // Add options to each course select
                                $('.course-select').each(function() {
                                    $(this).append(options.join(''));
                                });
                            } else {
                                // Show a warning if no courses are available
                                alert('No courses found for this semester. Please add courses to this semester before generating a routine.');
                            }

                            // Store lunch break information if available
                            if (data.lunch_break) {
                                // Store lunch break data as a data attribute on the semester select
                                $('#semester').data('lunch-break', data.lunch_break);

                                // Show lunch break information
                                $('#lunchBreakInfo').text(`Lunch Break: ${data.lunch_break.start} - ${data.lunch_break.end}`).show();

                                // Show lunch break section and populate time fields
                                $('#lunchBreakSection').show();
                                $('#lunchBreakStart').val(data.lunch_break.start);
                                $('#lunchBreakEnd').val(data.lunch_break.end);

                                // Initialize the time pickers for the lunch break fields
                                setTimeout(function() {
                                    $('#lunchBreakStart, #lunchBreakEnd').each(function() {
                                        // First destroy any existing instance
                                        if ($(this).data('mdtimepicker')) {
                                            $(this).mdtimepicker('destroy');
                                        }

                                        // Create a new instance
                                        $(this).mdtimepicker({
                                            format: 'hh:mm',
                                            theme: 'blue',
                                            hourPadding: true
                                        });
                                    });
                                }, 50);
                            } else {
                                $('#semester').removeData('lunch-break');
                                $('#lunchBreakInfo').hide();
                                $('#lunchBreakSection').show(); // Still show section but with empty values
                                $('#lunchBreakStart').val('');
                                $('#lunchBreakEnd').val('');

                                // Initialize the time pickers for the lunch break fields
                                setTimeout(function() {
                                    $('#lunchBreakStart, #lunchBreakEnd').each(function() {
                                        // First destroy any existing instance
                                        if ($(this).data('mdtimepicker')) {
                                            $(this).mdtimepicker('destroy');
                                        }
                                        // Create a new instance
                                        $(this).mdtimepicker({
                                            format: 'hh:mm',
                                            theme: 'blue',
                                            hourPadding: true
                                        });
                                    });
                                }, 50);
                            }

                            // Populate date range if available
                            if (data.date_range) {
                                // Store date range data as a data attribute on the semester select
                                $('#semester').data('date-range', data.date_range);

                                // Set the date range input value
                                const dateRangeStr = `${data.date_range.start_date} - ${data.date_range.end_date}`;
                                $('#date_range').val(dateRangeStr);

                                // Also update the daterangepicker with these dates
                                if ($('#date_range').data('daterangepicker')) {
                                    const startDate = moment(data.date_range.start_date, 'MM/DD/YYYY');
                                    const endDate = moment(data.date_range.end_date, 'MM/DD/YYYY');
                                    $('#date_range').data('daterangepicker').setStartDate(startDate);
                                    $('#date_range').data('daterangepicker').setEndDate(endDate);
                                }
                            } else {
                                // Clear the date range if no dates are stored
                                $('#semester').removeData('date-range');
                                $('#date_range').val('');
                            }

                            // Populate government holidays if available
                            if (data.holidays) {
                                // Store holidays data as a data attribute on the semester select
                                $('#semester').data('holidays', data.holidays);

                                // Get the Flatpickr instance
                                const holidayPicker = $('#govt_holidays')[0]._flatpickr;
                                if (holidayPicker) {
                                    // Clear any existing selected dates
                                    holidayPicker.clear();

                                    // Parse the comma-separated dates
                                    const holidayDates = data.holidays.split(',').filter(date => date.trim() !== '');

                                    // Set the selected dates in the picker
                                    if (holidayDates.length > 0) {
                                        const dateObjects = holidayDates.map(date => new Date(date.trim()));
                                        holidayPicker.setDate(dateObjects, true);

                                        // Update the hidden input for form submission
                                        $('#govt_holiday_dates').val(data.holidays);

                                        // Update visual display of selected holidays
                                        $('#selectedHolidays').empty();
                                        holidayDates.forEach(date => {
                                            const formattedDate = new Date(date).toLocaleDateString('en-US', {
                                                month: 'short',
                                                day: 'numeric',
                                                year: 'numeric'
                                            });
                                            const badge = $(`<span class="badge bg-info me-1 mb-1">${formattedDate} <i class="bi bi-x-circle"></i></span>`);
                                            $('#selectedHolidays').append(badge);
                                        });
                                    }
                                }
                            } else {
                                // Clear the holidays if none are stored
                                $('#semester').removeData('holidays');
                                // Clear the flatpickr instance if it exists
                                const holidayPicker = $('#govt_holidays')[0]._flatpickr;
                                if (holidayPicker) {
                                    holidayPicker.clear();
                                }
                                // Clear the hidden input and visual display
                                $('#govt_holiday_dates').val('');
                                $('#selectedHolidays').empty();
                            }

                            // Populate makeup/extra class dates if available
                            if (data.makeup_dates) {
                                // Store makeup dates data as a data attribute on the semester select
                                $('#semester').data('makeup-dates', data.makeup_dates);

                                // Get the Flatpickr instance
                                const makeupPicker = $('#makeup_dates')[0]._flatpickr;
                                if (makeupPicker) {
                                    // Clear any existing selected dates
                                    makeupPicker.clear();

                                    // Parse the comma-separated dates
                                    const makeupDateList = data.makeup_dates.split(',').filter(date => date.trim() !== '');

                                    // Set the selected dates in the picker
                                    if (makeupDateList.length > 0) {
                                        const dateObjects = makeupDateList.map(date => new Date(date.trim()));
                                        makeupPicker.setDate(dateObjects, true);

                                        // Update the hidden input for form submission
                                        $('#makeup_date_list').val(data.makeup_dates);

                                        // Update visual display of selected makeup dates
                                        $('#selectedMakeupDates').empty();
                                        makeupDateList.forEach(date => {
                                            const formattedDate = new Date(date).toLocaleDateString('en-US', {
                                                month: 'short',
                                                day: 'numeric',
                                                year: 'numeric'
                                            });
                                            const badge = $(`<span class="badge bg-success me-1 mb-1" data-date="${date}">${formattedDate} <i class="bi bi-x-circle" style="cursor: pointer;"></i></span>`);
                                            $('#selectedMakeupDates').append(badge);
                                        });
                                    }
                                }
                            } else {
                                // Clear the makeup dates if none are stored
                                $('#semester').removeData('makeup-dates');
                                // Clear the flatpickr instance if it exists
                                const makeupPicker = $('#makeup_dates')[0]._flatpickr;
                                if (makeupPicker) {
                                    makeupPicker.clear();
                                }
                                // Clear the hidden input and visual display
                                $('#makeup_date_list').val('');
                                $('#selectedMakeupDates').empty();
                            }

                            // Fetch and display existing routines for this semester
                            if (semesterId) {
                                $.ajax({
                                    url: "{% url 'check-time-overlap' %}",
                                    data: {
                                        'get_semester_routines': '1',
                                        'semester_id': semesterId
                                    },
                                    dataType: 'json',
                                    success: function(routineData) {
                                        // Clear existing course rows except the first one
                                        const firstRow = $('.course-row:first').clone();
                                        $('#courseRepeater').empty().append(firstRow);

                                        // Reset the first row
                                        firstRow.find('input').val('');
                                        firstRow.find('select').val('');
                                        firstRow.find('.overlap-feedback').hide().empty();

                                        // Populate the form with existing routines
                                        if (routineData.routines && routineData.routines.length > 0) {
                                            // Skip the first row as we've already added it
                                            let isFirstRow = true;

                                            routineData.routines.forEach(routine => {
                                                let row;
                                                if (isFirstRow) {
                                                    row = firstRow;
                                                    isFirstRow = false;
                                                } else {
                                                    // Clone the first row for additional routines
                                                    row = firstRow.clone();
                                                    $('#courseRepeater').append(row);
                                                }

                                                // Set the course
                                                row.find('select[name="course_code[]"]').val(routine.course_id);

                                                // Set the day
                                                row.find('select[name="day[]"]').val(routine.day);

                                                // Set the times
                                                row.find('input[name="start_time[]"]').val(routine.start_time);
                                                row.find('input[name="end_time[]"]').val(routine.end_time);
                                            });

                                            // Re-initialize time pickers after a short delay to ensure DOM is ready
                                            setTimeout(function() {
                                                // First destroy all timepickers to avoid duplicate initialization
                                                $('.mdtimepicker').each(function() {
                                                    if ($(this).data('mdtimepicker')) {
                                                        $(this).mdtimepicker('destroy');
                                                    }
                                                });

                                                // Initialize them again
                                                initMDTimePickers();

                                                // Re-check all time slots for overlaps
                                                $('.course-row').each(function() {
                                                    checkTimeOverlap($(this));
                                                });
                                            }, 100);

                                            // Add informational message
                                            const semesterName = $('#semester option:selected').text();
                                            const warningHtml = `
                                                <div class="alert alert-info mt-3 mb-3">
                                                    <h5><i class="bi bi-info-circle-fill"></i> Current Routine Loaded</h5>
                                                    <p class="mb-0">Current routine for <strong>${semesterName}</strong> has been loaded with ${routineData.routines.length} course(s).</p>
                                                    <p class="mb-0">You can modify times or add/remove courses as needed. All changes will update both the current routine and generate new schedule entries.</p>
                                                </div>
                                            `;

                                            // Add the warning before the course repeater
                                            if ($('#currentRoutineInfo').length) {
                                                $('#currentRoutineInfo').html(warningHtml);
                                            } else {
                                                $('#courseRepeater').before('<div id="currentRoutineInfo">' + warningHtml + '</div>');
                                            }
                                        }

                                        initMDTimePickers();

                                    }
                                });
                            }
                        }
                    });
                }
            }

            // Handle semester change
            $('#semester').change(function() {
                const semesterId = $(this).val();

                // Clear the current routine info when semester changes
                if ($('#currentRoutineInfo').length) {
                    $('#currentRoutineInfo').remove();
                }

                // Check if there are existing generated routines for this semester
                if (semesterId) {
                    $.ajax({
                        url: "{% url 'get-existing-generated-routines' %}",
                        data: {
                            'semester_id': semesterId
                        },
                        dataType: 'json',
                        success: function(data) {
                            if (data.has_routines) {
                                // Show loading message
                                $('body').append('<div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;"><div class="bg-white p-4 rounded"><i class="bi bi-arrow-clockwise"></i> Loading existing routine...</div></div>');
                                
                                // If there are existing routines, reload the page with the semester parameter
                                window.location.href = "{% url 'generate-routine' %}?semester=" + semesterId;
                            } else {
                                // If no existing routines, just load the semester courses normally
                                loadSemesterCourses(semesterId);
                                
                                // Show a message that no existing routine was found
                                const semesterName = $('#semester option:selected').text();
                                const noRoutineHtml = `
                                    <div class="alert alert-warning mt-3 mb-3">
                                        <h5><i class="bi bi-exclamation-triangle-fill"></i> No Existing Routine Found</h5>
                                        <p class="mb-0">No previously generated routine found for <strong>${semesterName}</strong>. You can create a new routine by filling out the form below.</p>
                                    </div>
                                `;
                                
                                // Remove any existing no routine message
                                if ($('#noRoutineInfo').length) {
                                    $('#noRoutineInfo').remove();
                                }
                                
                                // Add the message before the course repeater
                                $('#courseRepeater').before('<div id="noRoutineInfo">' + noRoutineHtml + '</div>');
                            }
                        },
                        error: function() {
                            // On error, just load the semester courses normally
                            loadSemesterCourses(semesterId);
                        }
                    });
                } else {
                    // If no semester selected, just load courses normally
                    loadSemesterCourses(semesterId);
                }
            });

            // Load courses for the initially selected semester, if any
            const initialSemester = $('#semester').val();
            if (initialSemester) {
                loadSemesterCourses(initialSemester);
            }

            // Function to check for time overlaps
            function checkTimeOverlap(row) {
                const courseSelect = $(row).find('select[name="course_code[]"]');
                const courseId = courseSelect.val();
                const daySelect = $(row).find('select[name="day[]"]');
                const day = daySelect.val();
                const startTime = $(row).find('input[name="start_time[]"]').val();
                const endTime = $(row).find('input[name="end_time[]"]').val();
                const feedbackDiv = $(row).find('.overlap-feedback');
                const checkingDiv = $(row).find('.checking-feedback');

                // Reset feedback and styles
                feedbackDiv.hide().empty();
                checkingDiv.hide();
                $(row).find('.time-input').removeClass('is-invalid');

                // Only check if all fields are filled
                if (!courseId || !day || !startTime || !endTime) {
                    $(row).removeClass('has-overlap');
                    return;
                }

                // Get teacher ID from the selected course
                const courseOption = courseSelect.find('option:selected');
                const courseName = courseOption.text();
                // Extract teacher ID from the data attribute
                const teacherId = courseOption.data('teacher-id');

                if (!teacherId) {
                    console.error('Teacher ID not found for selected course');
                    return;
                }

                // Get semester ID and lunch break info
                const semesterId = $('#semester').val();
                const lunchBreakStart = $('#lunchBreakStart').val();
                const lunchBreakEnd = $('#lunchBreakEnd').val();

                // Check for lunch break overlap (always enforced)
                if (lunchBreakStart && lunchBreakEnd) {
                    // Convert time strings to Date objects for easier comparison
                    const startDate = parseTimeString(startTime);
                    const endDate = parseTimeString(endTime);
                    const lunchStartDate = parseTimeString(lunchBreakStart);
                    const lunchEndDate = parseTimeString(lunchBreakEnd);

                    // Check if time slot overlaps with lunch break
                    if (doTimesOverlap(startDate, endDate, lunchStartDate, lunchEndDate)) {
                        feedbackDiv.html(`Overlaps with lunch break (${lunchBreakStart} - ${lunchBreakEnd})`).show();
                        $(row).find('.time-input').addClass('is-invalid');
                        $(row).addClass('has-overlap');

                        // Disable submit button due to lunch break overlap
                        $('button[type="submit"]').prop('disabled', true);
                        return;
                    }
                }

                // Show checking indicator
                checkingDiv.show();

                // Check for overlaps via AJAX
                $.ajax({
                    url: "{% url 'check-time-overlap' %}",
                    data: {
                        'day': day,
                        'start_time': startTime,
                        'end_time': endTime,
                        'teacher_id': teacherId,
                        'course_id': courseId,  // Pass the course ID to exclude it from the check
                        'semester_id': semesterId, // Pass semester ID to check for lunch break
                        'enforce_lunch_break': "1", // Always enforce lunch break
                        'lunch_break_start': lunchBreakStart,
                        'lunch_break_end': lunchBreakEnd
                    },
                    dataType: 'json',
                    success: function(data) {
                        // Hide checking indicator
                        checkingDiv.hide();

                        if (data.overlaps && data.overlaps.length > 0) {
                            // Show overlap warning
                            const messages = data.overlaps.map(overlap =>
                                `Overlaps with: ${overlap.course} - ${overlap.course_name} (${overlap.teacher}) ${overlap.start} - ${overlap.end}`
                            );

                            feedbackDiv.html(messages.join('<br>')).show();
                            $(row).find('.time-input').addClass('is-invalid');
                            $(row).addClass('has-overlap');

                            // Disable submit button if there are overlaps
                            $('button[type="submit"]').prop('disabled', true);
                        } else {
                            // No overlaps for this row
                            $(row).removeClass('has-overlap');

                            // Re-enable submit button if no overlaps on this row
                            // Need to check other rows too
                            checkAllRows();
                        }
                    },
                    error: function(xhr, status, error) {
                        // Hide checking indicator
                        checkingDiv.hide();
                        console.error('Error checking time overlap:', error);
                    }
                });
            }

            // Check all rows for any overlap
            function checkAllRows() {
                let hasOverlap = false;
                let allOverlaps = [];

                $('.course-row').each(function() {
                    const feedbackDiv = $(this).find('.overlap-feedback');
                    if (feedbackDiv.is(':visible')) {
                        hasOverlap = true;
                        const courseSelect = $(this).find('select[name="course_code[]"]');
                        const courseName = courseSelect.find('option:selected').text();
                        const day = $(this).find('select[name="day[]"] option:selected').text();
                        const startTime = $(this).find('input[name="start_time[]"]').val();
                        const endTime = $(this).find('input[name="end_time[]"]').val();

                        // Add to all overlaps list
                        const overlapText = `${courseName} on ${day} (${startTime} - ${endTime})`;
                        allOverlaps.push(overlapText);
                    }
                });

                // Update global overlap warning
                if (hasOverlap) {
                    const overlapList = $('#overlapList');
                    overlapList.empty();
                    allOverlaps.forEach(overlap => {
                        overlapList.append(`<li>${overlap}</li>`);
                    });
                    $('#overlapWarning').show();
                } else {
                    $('#overlapWarning').hide();
                }

                // Enable/disable submit button based on overlaps
                $('button[type="submit"]').prop('disabled', hasOverlap);
            }

            // Event listeners for time inputs and related selects
            $(document).on('change', 'select[name="course_code[]"], select[name="day[]"], input[name="start_time[]"], input[name="end_time[]"]', function() {
                const row = $(this).closest('.course-row');
                checkTimeOverlap(row);
                checkAllCourseOverlaps();
            });

            // Event listener for lunch break time changes
            $('#lunchBreakStart, #lunchBreakEnd').on('change', function() {
                const startTime = $('#lunchBreakStart').val();
                const endTime = $('#lunchBreakEnd').val();

                // Update the lunch break info display
                if (startTime && endTime) {
                    $('#lunchBreakInfo').text(`Lunch Break: ${startTime} - ${endTime}`).show();

                    // Update the data attribute with new values
                    $('#semester').data('lunch-break', {
                        start: startTime,
                        end: endTime
                    });

                    // Recheck all rows for overlaps
                    $('.course-row').each(function() {
                        checkTimeOverlap($(this));
                    });
                } else {
                    $('#lunchBreakInfo').hide();
                }
            });

            // Also check after the time picker is closed
            $(document).on('mdtimepicker:close', '.time-input', function() {
                const row = $(this).closest('.course-row');
                checkTimeOverlap(row);
                checkAllCourseOverlaps();
            });

            // Handle adding new course rows
            $('#addCourse').click(function () {
                // Clone only the HTML, not data/events
                const $firstRow = $('.course-row:first');
                const $newRow = $firstRow.clone(false, false);

                // Clear all input/select values in the new row
                $newRow.find('input').val('');
                $newRow.find('select').val('');

                // Remove any plugin artifacts (e.g., time pickers)
                $newRow.find('.mdtimepicker').each(function() {
                    // Remove any time picker plugin DOM artifacts if present
                    $(this).off(); // Remove all event handlers
                    $(this).removeClass('mdtimepicker-input');
                });

                // Remove any error or feedback messages
                $newRow.find('.overlap-feedback, .checking-feedback').hide();

                // Append the new row
                $('#courseRepeater').append($newRow);

                // Re-initialize time pickers on the new row
                $newRow.find('.mdtimepicker').mdtimepicker({
                    format: 'hh:mm',
                    theme: 'blue',
                    hourPadding: true
                });
                checkAllCourseOverlaps();
            });

            $(document).on('click', '.remove-course', function () {
                if ($('.course-row').length > 1) {
                    $(this).closest('.course-row').remove();
                    checkAllCourseOverlaps();
                }
            });

            // Inline editing functionality for routine table
            $(document).on('click', '.course-cell, .empty-cell', function(e) {
                // Prevent triggering when clicking on edit controls or their children
                if ($(e.target).closest('.edit-controls').length || 
                    $(e.target).hasClass('form-select') || 
                    $(e.target).hasClass('btn') ||
                    $(e.target).closest('.btn').length) {
                    e.stopPropagation();
                    return;
                }
                const cell = $(this);
                const isEmptyCell = cell.hasClass('empty-cell');
                const routineId = cell.data('routine-id');
                const courseId = cell.data('course-id');
                
                // Get current semester
                const semesterId = $('#semester').val();
                if (!semesterId) {
                    alert('Please select a semester first.');
                    return;
                }
                
                // Fetch semester courses via AJAX
                $.ajax({
                    url: "{% url 'get-semester-courses' %}",
                    data: { 'semester_id': semesterId },
                    dataType: 'json',
                    success: function(data) {
                        const select = cell.find('.course-select-edit');
                        select.empty();
                        select.append('<option value="">Select Course</option>');
                        if (data.courses && data.courses.length > 0) {
                            data.courses.forEach(function(course) {
                                const option = $('<option></option>')
                                    .val(course.id)
                                    .text(course.code + ' - ' + course.name + ' (' + course.teacher_name + ')');
                                if (course.id == courseId) option.prop('selected', true);
                                select.append(option);
                            });
                        }
                        cell.find('.edit-controls').show();
                        if (isEmptyCell) {
                            cell.find('.empty-cell-content').hide();
                        } else {
                            cell.find('.course-code, .teacher-name').hide();
                        }
                    },
                    error: function() {
                        alert('Could not load courses for this semester.');
                    }
                });
            });

            $(document).on('click', '.save-course', function() {
                const cell = $(this).closest('.course-cell, .empty-cell');
                const isEmptyCell = cell.hasClass('empty-cell');
                const routineId = cell.data('routine-id');
                const select = cell.find('.course-select-edit');
                const newCourseId = select.val();
                
                if (!newCourseId) {
                    alert('Please select a course');
                    return;
                }
                
                // Show loading state
                const saveBtn = $(this);
                const originalText = saveBtn.text();
                saveBtn.text('Saving...').prop('disabled', true);
                
                // Prepare data for AJAX request
                const ajaxData = {
                    'course_id': newCourseId,
                    'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                };
                
                if (isEmptyCell) {
                    // Creating new entry
                    ajaxData['date'] = cell.data('date');
                    ajaxData['day'] = cell.data('day');
                    ajaxData['time_slot'] = cell.data('time-slot');
                    ajaxData['semester_id'] = $('#semester').val();
                    ajaxData['start_time'] = cell.data('start-time');
                    ajaxData['end_time'] = cell.data('end-time');
                } else {
                    // Updating existing entry
                    ajaxData['routine_id'] = routineId;
                }
                
                // Send AJAX request
                $.ajax({
                    url: "{% url 'update-routine-course' %}",
                    method: 'POST',
                    data: ajaxData,
                    success: function(response) {
                        if (response.success) {
                            if (isEmptyCell) {
                                // Convert empty cell to course cell
                                cell.removeClass('empty-cell').addClass('course-cell bg-primary text-white');
                                cell.removeAttr('data-date data-day data-time-slot');
                                cell.data('routine-id', response.routine_id);
                                cell.data('course-id', newCourseId);

                                // Update the display with icons and content
                                cell.html(`
                                    <span style="position: absolute; top: 2px; right: 4px; z-index: 2; cursor: pointer; opacity: 0.8; color: #1E1E1E;" title="Edit course">
                                      <!-- Pen SVG icon -->
                                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.3 3.7l4 4L7 17H3v-4l9.3-9.3z"/><path d="M15.7 6.3l-2-2"/></svg>
                                    </span>
                                    <span style="position: absolute; top: 2px; left: 4px; z-index: 2; cursor: pointer; opacity: 0.8; color: #1E1E1E;" class="remove-course-btn" title="Remove course">
                                      <!-- Trash SVG icon -->
                                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                    </span>
                                    <div class="fw-bold course-code">${response.course_code}</div>
                                    <div><small class="teacher-name">(${response.teacher_name})</small></div>
                                    <div class="edit-controls" style="display: none;">
                                        <select class="form-select form-select-sm course-select-edit">
                                            <option value="">Select Course</option>
                                        </select>
                                        <div class="mt-1">
                                            <button type="button" class="btn btn-success btn-sm save-course">Save</button>
                                            <button type="button" class="btn btn-secondary btn-sm cancel-edit">Cancel</button>
                                        </div>
                                    </div>
                                `);
                            } else {
                                // Update existing course cell
                                cell.find('.course-code').text(response.course_code).show();
                                cell.find('.teacher-name').text('(' + response.teacher_name + ')').show();
                                cell.find('.edit-controls').hide();
                                cell.data('course-id', newCourseId);
                            }
                            
                            // Show success message
                            const successMsg = $('<div class="alert alert-success alert-dismissible fade show" role="alert">Course ' + (isEmptyCell ? 'added' : 'updated') + ' successfully!<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                            $('.messages').append(successMsg);
                            
                            // Auto-dismiss after 3 seconds
                            setTimeout(function() {
                                successMsg.alert('close');
                            }, 3000);
                        } else {
                            alert('Error ' + (isEmptyCell ? 'adding' : 'updating') + ' course: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Error ' + (isEmptyCell ? 'adding' : 'updating') + ' course';
                        alert(errorMsg);
                    },
                    complete: function() {
                        // Reset button state
                        saveBtn.text(originalText).prop('disabled', false);
                    }
                });
            });

            $(document).on('click', '.cancel-edit', function() {
                const cell = $(this).closest('.course-cell, .empty-cell');
                const isEmptyCell = cell.hasClass('empty-cell');
                
                cell.find('.edit-controls').hide();
                if (isEmptyCell) {
                    cell.find('.empty-cell-content').show();
                } else {
                    cell.find('.course-code, .teacher-name').show();
                }
            });

            // Prevent dropdown from closing when clicking on it
            $(document).on('click', '.course-select-edit', function(e) {
                e.stopPropagation();
            });

            // Prevent dropdown from closing when clicking on buttons
            $(document).on('click', '.save-course, .cancel-edit', function(e) {
                e.stopPropagation();
            });

            // Close edit mode when clicking outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('.course-cell').length) {
                    $('.edit-controls').hide();
                    $('.course-code, .teacher-name').show();
                }
            });

            // Handle remove course button clicks
            $(document).on('click', '.remove-course-btn', function(e) {
                e.stopPropagation();
                const cell = $(this).closest('.course-cell');
                const routineId = cell.data('routine-id');
                
                if (!routineId) {
                    alert('No routine entry found to remove.');
                    return;
                }
                
                if (!confirm('Are you sure you want to remove this course from this time slot?')) {
                    return;
                }
                
                // Show loading state
                const removeBtn = $(this);
                const originalOpacity = removeBtn.css('opacity');
                removeBtn.css('opacity', '0.3');
                
                // Send AJAX request to remove the course
                $.ajax({
                    url: "{% url 'remove-routine-course' %}",
                    method: 'POST',
                    data: {
                        'routine_id': routineId,
                        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Convert course cell back to empty cell
                            // Get date from the first td's data-date attribute (correct format)
                            const date = cell.closest('tr').find('td:first').attr('data-date');
                            const day = cell.closest('tr').find('td:nth-child(2)').text();
                            const timeSlot = cell.index() - 2; // -2 for date/day columns

                            // Get time information from the table header
                            const ths = document.querySelectorAll('.generate-routine-table thead tr:nth-child(2) th');
                            const th = ths[timeSlot + 2]; // +2 to skip date/day columns
                            let startTime = '';
                            let endTime = '';
                            if (th) {
                                startTime = th.getAttribute('data-start-time') || '';
                                endTime = th.getAttribute('data-end-time') || '';
                            }
                            
                            cell.removeClass('course-cell bg-primary text-white').addClass('empty-cell');
                            cell.removeAttr('data-routine-id data-course-id');
                            cell.attr({
                                'data-date': date,
                                'data-day': day,
                                'data-time-slot': timeSlot,
                                'data-start-time': startTime,
                                'data-end-time': endTime
                            });
                            cell.css('background-color', '#f8f9fa');
                            
                            // Update the display
                            cell.html(`
                                <span style="position: absolute; top: 2px; right: 4px; z-index: 2; cursor: pointer; opacity: 0.7;">
                                  <!-- Pen SVG icon -->
                                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.3 3.7l4 4L7 17H3v-4l9.3-9.3z"/><path d="M15.7 6.3l-2-2"/></svg>
                                </span>
                                <div class="empty-cell-content" style="display: block;">
                                    <small class="text-muted">Click to add course</small>
                                </div>
                                <div class="edit-controls" style="display: none;">
                                    <select class="form-select form-select-sm course-select-edit">
                                        <option value="">Select Course</option>
                                    </select>
                                    <div class="mt-1">
                                        <button type="button" class="btn btn-success btn-sm save-course">Save</button>
                                        <button type="button" class="btn btn-secondary btn-sm cancel-edit">Cancel</button>
                                    </div>
                                </div>
                            `);
                            
                            // Show success message
                            const successMsg = $('<div class="alert alert-success alert-dismissible fade show" role="alert">Course removed successfully!<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>');
                            $('.messages').append(successMsg);
                            
                            // Auto-dismiss after 3 seconds
                            setTimeout(function() {
                                successMsg.alert('close');
                            }, 3000);
                        } else {
                            alert('Error removing course: ' + (response.error || 'Unknown error'));
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON ? xhr.responseJSON.error : 'Error removing course';
                        alert(errorMsg);
                    },
                    complete: function() {
                        // Reset button state
                        removeBtn.css('opacity', originalOpacity);
                    }
                });
            });

            // Get all time slot headers (skip first two th for date/day)
            const ths = document.querySelectorAll('.generate-routine-table thead tr:nth-child(2) th');
            // Add data-start-time and data-end-time to each time slot header by parsing the label
            ths.forEach(function(th, idx) {
                if (idx < 2) return; // skip date/day columns
                const label = th.textContent.trim();
                const match = label.match(/(\d{2}:\d{2})\s*-\s*(\d{2}:\d{2})/);
                if (match) {
                    th.setAttribute('data-start-time', match[1]);
                    th.setAttribute('data-end-time', match[2]);
                }
            });
            // For each empty cell, set start/end time from header if missing
            document.querySelectorAll('.empty-cell').forEach(function(td) {
                const slotIdx = parseInt(td.getAttribute('data-time-slot'), 10);
                const th = ths[slotIdx + 2]; // +2 to skip date/day columns
                if (th) {
                    if (!td.getAttribute('data-start-time') || !td.getAttribute('data-end-time')) {
                        td.setAttribute('data-start-time', th.getAttribute('data-start-time'));
                        td.setAttribute('data-end-time', th.getAttribute('data-end-time'));
                    }
                }
            });
        });

        // Ensure the PDF export form submits the correct teacher short name option
        document.getElementById('pdfExportForm').addEventListener('submit', function(e) {
            var checked = document.getElementById('teacherShortNameNewline').checked;
            document.getElementById('pdfTeacherShortNameNewline').value = checked ? '1' : '0';
        });

        // On page load, set the PDF export hidden input to match the checkbox
        document.getElementById('pdfTeacherShortNameNewline').value = document.getElementById('teacherShortNameNewline').checked ? '1' : '0';
    </script>
</body>
</html>
